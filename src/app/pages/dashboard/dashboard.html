<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="../../../styles.css">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .conteudo {
        margin: 36px;
      }

      .box-graph {
        margin: 36px;
      }

      .chart-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        height: 400px;
        margin: auto;
        padding: 20px;
      }

      @media (max-width: 999px) { /* Ajustes para mobile */
        body {
          margin-bottom: 256px;
        }

        .conteudo {
          margin: 16px;
        }

        .chart-container {
          width: 1000px;
          padding: 0;
          margin-right: 16px;
        }

        .box-graph {
          margin: 0;
          margin-top: 16px;
        }
      }

      @media (min-width: 1000px) { /* Ajustes para desktop */
        .chart-container {
          max-width: 700px;
          height: 500px;
        }
      }
    </style>
  </head>
  <body>
    <div class="conteudo">
      <h1 class="mb-4 text-center">Dashboard</h1>
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Total de Agendamentos</h5>
              <p id="total-appointments" class="card-text">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Total de Clientes</h5>
              <p id="total-clients" class="card-text">0</p>
            </div>
          </div>
        </div>
      </div>
      <div class="box-graph">
        <h1 class="mb-4 text-center">Agendamentos por Cliente</h1>
        <div class="chart-container">
          <canvas id="horizontalBarChart"></canvas>
        </div>
      </div>
      <div id="top3procedimentos">
        <h2 class="mb-4 mt-4">Top 3 Procedimentos Mais Usados</h2>
        <table class="table">
          <thead>
            <tr>
              <th>Procedimento</th>
              <th>Quantidade de Agendamentos</th>
            </tr>
          </thead>
          <tbody id="top-procedures-table">
            <!-- Conteúdo preenchido dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Função para realizar fetch com o token de autenticação
        function fetchWithToken(url, options = {}) {
          const token = localStorage.getItem('authToken');
          const headers = {
            ...options.headers,
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json',
          };

          return fetch(url, { ...options, headers });
        }

        // Função para criar um gráfico de barras horizontais
        function createHorizontalBarChart(clientNames, appointmentCounts) {
          const ctx = document.getElementById("horizontalBarChart").getContext("2d");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: clientNames,
              datasets: [
                {
                  label: "Quantidade de Agendamentos",
                  data: appointmentCounts,
                  backgroundColor: "rgba(75, 192, 192, 0.5)",
                  borderColor: "rgba(75, 192, 192, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              indexAxis: 'y', // Configura para barras horizontais
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Quantidade de Agendamentos",
                    font: {
                      size: 16,
                      weight: "bold",
                    },
                  },
                  beginAtZero: true,
                  grid: {
                    color: "rgba(200, 200, 200, 0.3)",
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Clientes",
                    font: {
                      size: 16,
                      weight: "bold",
                    },
                  },
                  grid: {
                    display: false,
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
              },
            },
          });
        }

        // Função para carregar os top 3 procedimentos mais usados
        function loadTopProcedures() {
          fetchWithToken("/api/dashboard")
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("total-appointments").textContent =
                data.totalAppointments;
              document.getElementById("total-clients").textContent =
                data.totalClients;

              const topProceduresTable = document.getElementById("top-procedures-table");
              data.topProcedures.forEach(proc => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${proc.procedureName}</td>
                  <td>${proc.count}</td>
                `;
                topProceduresTable.appendChild(row);
              });
            })
            .catch((error) =>
              console.error("Erro ao carregar o dashboard:", error)
            );
        }

        // Carregar dados do gráfico de agendamentos por cliente
        fetchWithToken("/api/appointments-by-client")
          .then((response) => response.json())
          .then((data) => {
            const clientNames = data.map((item) => item.client_name);
            const appointmentCounts = data.map((item) => item.appointment_count);

            // Cria o gráfico de barras horizontais
            createHorizontalBarChart(clientNames, appointmentCounts);
          })
          .catch((error) =>
            console.error("Erro ao carregar os dados do gráfico:", error)
          );

        // Carregar os dados do dashboard, incluindo top 3 procedimentos
        loadTopProcedures();
      });
    </script>    
  </body>
</html>
