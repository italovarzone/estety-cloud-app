<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meus Agendamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Esconde a tabela em telas menores que 768px */
        @media (max-width: 767px) {
            .desktop-view {
                display: none;
            }
            .mobile-view {
                display: block;
            }
        }

        /* Esconde os cards em telas maiores que 768px */
        @media (min-width: 768px) {
            .mobile-view {
                display: none;
            }
            .desktop-view {
                display: block;
            }

            .form-check {
                padding-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div style="margin: 32px">
        <h1 class="mb-4">Meus Agendamentos</h1>
        <div class="row mb-3">
            <div style="display: flex; gap: 8px;">
                <div style="display: flex; flex-wrap: wrap; gap: 16px;" class="row">
                    <div class="col-md-6">
                        <select id="filter-status" class="form-select">
                            <option value="nao-concluidos">Não Concluídos</option>
                            <option value="concluidos">Concluídos</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="filter-name" class="form-control" placeholder="Digite o nome do cliente..." />
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-older-than-20-days" />
                            <label class="form-check-label" for="filter-older-than-20-days">
                                a mais de 15 dias 
                            </label>
                        </div>
                    </div>
                </div>
        </div>

        <!-- Versão Desktop (Tabela) -->
        <div class="desktop-view" style="max-height: 330px; overflow-y: auto;">
            <table id="appointment-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Procedimento</th>
                        <th>Data</th>
                        <th>Hora</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- A mensagem será inserida aqui -->
                </tbody>
            </table>
        </div>

        <!-- Versão Mobile (Cards) -->
        <div style="margin-bottom: 256px" id="appointments-container" class="mobile-view row gy-4">
            <!-- Cards de agendamentos serão inseridos aqui -->
        </div>
    </div>

    <!-- Modais para ambos Mobile e Desktop -->
    <!-- Modal de Confirmação de Conclusão -->
    <div class="modal fade" id="confirmConcludeModal" tabindex="-1" aria-labelledby="confirmConcludeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmConcludeModalLabel">Confirmar Conclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Tem certeza que deseja concluir este agendamento?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirmConcludeButton" class="btn btn-success">Concluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmCancelModalLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Tem certeza que deseja cancelar e remover este agendamento?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" id="confirmCancelButton" class="btn btn-danger">Excluir</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Modal para Agendamento Vencido -->
    <div class="modal fade" id="expiredAppointmentModal" tabindex="-1" aria-labelledby="expiredAppointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expiredAppointmentModalLabel">Agendamento Vencido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="expiredAppointmentMessage">O agendamento já passou. Deseja concluí-lo ou deletá-lo?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" id="deleteExpiredAppointment" class="btn btn-danger">Deletar</button>
                    <button type="button" id="concludeExpiredAppointment" class="btn btn-success">Concluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reagendamento -->
    <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rescheduleModalLabel">Reagendar Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Exibição de informações do cliente e procedimento -->
                    <p style="margin: 0;" id="rescheduleClientInfo">Cliente:</p>
                    <p id="rescheduleProcedureInfo">Procedimento:</p>
                    <form id="rescheduleForm">
                        <div class="mb-3">
                            <label for="newDate" class="form-label">Data</label>
                            <input type="date" id="newDate" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="newTime" class="form-label">Hora</label>
                            <input type="time" id="newTime" class="form-control" required />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirmRescheduleButton" class="btn btn-primary">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", init);

function init() {
    loadAppointments(); // Carrega a lista de agendamentos ao iniciar

    document.getElementById("filter-status").addEventListener("change", loadAppointments);
    document.getElementById("filter-name").addEventListener("input", loadAppointments);
    document.getElementById("filter-older-than-20-days").addEventListener("change", loadAppointments);
}

// Função para realizar fetch com o token de autenticação
function fetchWithToken(url, options = {}) {
    const token = localStorage.getItem('authToken');  // Obter o token do localStorage
    const headers = {
        ...options.headers,
        'Authorization': token ? `Bearer ${token}` : '',  // Inclui o token no cabeçalho de autorização
        'Content-Type': 'application/json',  // Define o tipo de conteúdo como JSON
    };

    return fetch(url, { ...options, headers });  // Retorna o fetch com os headers atualizados
}

let expiredAppointmentsQueue = []; // Fila para armazenar os agendamentos vencidos
let appointmentToHandle = null; // Armazena o agendamento atual que está sendo manipulado

function formatDateForDisplay(dateString) {
    const dateParts = dateString.split('-');
    return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
}

let isLoading = false;
// Função para carregar agendamentos
function loadAppointments() {
    if (isLoading) return; // Impede chamadas concorrentes
    isLoading = true;

    const filterStatus = document.getElementById("filter-status").value;
    const filterName = document.getElementById("filter-name").value.toLowerCase();
    const filterOlderThan20Days = document.getElementById("filter-older-than-20-days").checked;
    
    let url = "/api/appointments";
    const params = new URLSearchParams();

    // Adiciona o status ao parâmetro de consulta
    params.append('status', filterStatus === 'concluidos' ? 'concluidos' : 'nao-concluidos');

    // Adiciona o termo de pesquisa ao parâmetro de consulta
    if (filterName) {
        params.append('search', filterName);
    }

    // Adiciona o filtro de "há mais de 20 dias" se for aplicável
    if (filterStatus === 'concluidos' && filterOlderThan20Days) {
        params.append('olderThan20Days', 'true');
    }

    url += '?' + params.toString();

    fetchWithToken(url)
        .then((response) => response.json())
        .then((data) => {
            const tbody = document.querySelector("#appointment-table tbody");
            tbody.innerHTML = "";

            const container = document.getElementById("appointments-container");
            container.innerHTML = "";

            expiredAppointmentsQueue = []; // Limpa a fila de agendamentos vencidos

            if (data.appointments && data.appointments.length > 0) {
                data.appointments.forEach((appointment) => {
                    // Adiciona os agendamentos vencidos à fila
                    if (filterStatus === 'nao-concluidos' && appointment.expired) {
                        expiredAppointmentsQueue.push(appointment);
                    }

                    // Renderiza a tabela para desktop
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${appointment.client.name}</td>
                        <td>${appointment.procedure}</td>
                        <td>${formatDateForDisplay(appointment.date)}</td>
                        <td>${appointment.time}</td>
                        <td>
                            <button title="Concluir Agendamento" class="btn btn-sm btn-success" ${
                                filterStatus === "concluidos" ? "disabled" : ""
                            } onclick="concludeAppointment('${appointment.id}')">
                                <i class="fa-regular fa-circle-check"></i>
                            </button>
                            <button title="Reagendar Agendamento" class="btn btn-sm btn-warning" onclick="showRescheduleModal('${appointment.id}', '${appointment.date}', '${appointment.time}', '${appointment.client.name}', '${appointment.procedure}')">
                                <i class="fa-solid fa-calendar-alt"></i>
                            </button>
                            <button title="Cancelar Agendamento" class="btn btn-sm btn-danger" ${
                                filterStatus === "concluidos" ? "disabled" : ""
                            } onclick="cancelAppointment('${appointment.id}')">
                                <i class="fa-solid fa-ban"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Renderiza o card para mobile
                    const card = document.createElement("div");
                    card.classList.add("col-md-6", "col-lg-4");
                    card.innerHTML = `
                        <br>
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${appointment.client.name}</h5>
                                <p class="card-text"><strong>Procedimento:</strong> ${appointment.procedure}</p>
                                <p class="card-text"><strong>Data:</strong> ${formatDateForDisplay(appointment.date)}</p>
                                <p class="card-text"><strong>Hora:</strong> ${appointment.time}</p>
                            </div>
                            <div class="card-footer d-flex justify-content-end gap-2">
                                <button title="Concluir Agendamento" class="btn btn-sm btn-success" ${
                                    filterStatus === "concluidos" ? "disabled" : ""
                                } onclick="concludeAppointment('${appointment.id}')">
                                    <i class="fa-regular fa-circle-check"></i>
                                </button>
                                <button title="Reagendar Agendamento" class="btn btn-sm btn-warning" onclick="showRescheduleModal('${appointment.id}', '${appointment.date}', '${appointment.time}', '${appointment.client.name}', '${appointment.procedure}')">
                                    <i class="fa-solid fa-calendar-alt"></i>
                                </button>
                                <button title="Cancelar Agendamento" class="btn btn-sm btn-danger" ${
                                    filterStatus === "concluidos" ? "disabled" : ""
                                } onclick="cancelAppointment('${appointment.id}')">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

                // Inicia o processamento dos agendamentos vencidos
                processExpiredAppointments();
                isLoading = false;
            } else {
                isLoading = false;
                displayNoAppointmentsMessage(tbody, container);
            }
        })
        .catch((error) => {
            console.error("Erro ao carregar agendamentos:", error);
            const tbody = document.querySelector("#appointment-table tbody");
            const container = document.getElementById("appointments-container");
            displayNoAppointmentsMessage(tbody, container, true);
            isLoading = false;
        });
}

let appointmentToReschedule = null;

function showRescheduleModal(id, currentDate, currentTime, clientName, procedureName) {
    appointmentToReschedule = id;
    // Preenche os inputs com a data e hora atuais
    document.getElementById('newDate').value = currentDate;
    document.getElementById('newTime').value = currentTime;
    // Preenche as informações do cliente e procedimento no modal
    document.getElementById('rescheduleClientInfo').textContent = `Cliente: ${clientName}`;
    document.getElementById('rescheduleProcedureInfo').textContent = `Procedimento: ${procedureName}`;
    const modal = new bootstrap.Modal(document.getElementById("rescheduleModal"));
    modal.show();
}

async function checkAvailability(date, time) {
    const response = await fetchWithToken(`/api/appointments/check-availability?date=${date}&time=${time}`);
    const data = await response.json();
    return data.available;
}

document.getElementById('confirmRescheduleButton').addEventListener('click', async () => {
    const newDate = document.getElementById('newDate').value;
    const newTime = document.getElementById('newTime').value;

    const isAvailable = await checkAvailability(newDate, newTime);
    if (!isAvailable) {
        alert("Já existe um agendamento não concluído neste horário. Por favor, escolha outro horário.");
        return;
    }

    // Proceder com a requisição para reagendar se estiver disponível
    fetchWithToken(`/api/appointments/${appointmentToReschedule}/reschedule`, {
        method: "PUT",
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ date: newDate, time: newTime })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById("rescheduleModal"));
            modal.hide();
            loadAppointments();
        } else {
            console.error("Erro ao reagendar agendamento.");
        }
    })
    .catch(error => console.error("Erro ao reagendar agendamento:", error));
});

// Função para formatar a data no formato "08 de outubro de 2024"
function formatDate(dateString) {
    const date = new Date(dateString); // Converte a string de data em um objeto Date
    return date.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
    });
}

// Função para processar agendamentos vencidos
function processExpiredAppointments() {
    if (expiredAppointmentsQueue.length > 0) {
        // Pega o próximo agendamento na fila
        const nextAppointment = expiredAppointmentsQueue.shift();
        appointmentToHandle = nextAppointment.id; // Armazena o agendamento atual para uso posterior

        // Formata a data no formato "08 de outubro de 2024"
        const formattedDate = formatDate(nextAppointment.date);

        // Atualiza a mensagem do modal com os dados do agendamento vencido
        document.getElementById('expiredAppointmentMessage').textContent = 
            `O agendamento de ${nextAppointment.client.name} no dia ${formattedDate} está vencido! Deseja concluí-lo ou deletá-lo?`;

        // Exibe o modal
        const modal = new bootstrap.Modal(document.getElementById("expiredAppointmentModal"));
        modal.show();
    } else {
        // Se não houver mais agendamentos na fila, recarrega a lista
        loadAppointments(); // Recarrega os agendamentos após processar todos os vencidos
    }
}

// Função para concluir o agendamento vencido diretamente no modal
document.getElementById('concludeExpiredAppointment').addEventListener('click', () => {
    if (appointmentToHandle) {
        // Concluir o agendamento diretamente
        fetchWithToken(`/api/appointments/${appointmentToHandle}/conclude`, {
            method: "PUT"
        })
        .then((response) => response.json())
        .then(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById("expiredAppointmentModal"));
            modal.hide();
            appointmentToHandle = null; // Limpa a variável após a ação
            processExpiredAppointments(); // Processa o próximo agendamento vencido na fila
        })
        .catch((error) => console.error("Erro ao concluir agendamento:", error));
    }
});

// Função para deletar o agendamento vencido diretamente no modal
document.getElementById('deleteExpiredAppointment').addEventListener('click', () => {
    if (appointmentToHandle) {
        // Deletar o agendamento diretamente
        fetchWithToken(`/api/appointments/${appointmentToHandle}`, {
            method: "DELETE"
        })
        .then((response) => response.json())
        .then(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById("expiredAppointmentModal"));
            modal.hide();
            appointmentToHandle = null; // Limpa a variável após a ação
            processExpiredAppointments(); // Processa o próximo agendamento vencido na fila
        })
        .catch((error) => console.error("Erro ao deletar agendamento:", error));
    }
});


function displayNoAppointmentsMessage(tbody, container, error = false) {
    const message = error ? "Erro ao carregar agendamentos. Tente novamente mais tarde." : "Nenhum agendamento encontrado.";
    
    const noAppointmentsMessageTable = document.createElement("tr");
    noAppointmentsMessageTable.innerHTML = `
        <td colspan="5" class="text-center text-muted">${message}</td>
    `;
    tbody.appendChild(noAppointmentsMessageTable);

    const noAppointmentsMessageCard = document.createElement("div");
    noAppointmentsMessageCard.classList.add("col-12");
    noAppointmentsMessageCard.innerHTML = `
        <p class="text-center text-muted">${message}</p>
    `;
    container.appendChild(noAppointmentsMessageCard);
}

let appointmentToConclude = null;

function concludeAppointment(id) {
    appointmentToConclude = id;
    const modal = new bootstrap.Modal(document.getElementById("confirmConcludeModal"));
    modal.show();
}

document.getElementById("confirmConcludeButton").addEventListener("click", () => {
    if (appointmentToConclude !== null) {
        fetchWithToken(`/api/appointments/${appointmentToConclude}/conclude`, {
            method: "PUT",
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmConcludeModal"));
                    modal.hide();
                    loadAppointments();
                } else {
                    console.error("Erro ao concluir agendamento.");
                }
            })
            .catch((error) => console.error("Erro ao concluir agendamento:", error));
    }
});

let appointmentToCancel = null;

function cancelAppointment(id) {
    appointmentToCancel = id;
    const modal = new bootstrap.Modal(document.getElementById("confirmCancelModal"));
    modal.show();
}

document.getElementById("confirmCancelButton").addEventListener("click", () => {
    if (appointmentToCancel !== null) {
        fetchWithToken(`/api/appointments/${appointmentToCancel}`, {
            method: "DELETE",
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmCancelModal"));
                    modal.hide();
                    loadAppointments();
                } else {
                    console.error("Erro ao cancelar e remover agendamento.");
                }
            })
            .catch((error) => console.error("Erro ao cancelar e remover agendamento:", error));
    }
});
    </script>     
</body>
</html>
